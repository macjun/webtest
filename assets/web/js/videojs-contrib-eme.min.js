/*! @name videojs-contrib-eme @version 5.5.1 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("video.js")):"function"==typeof define&&define.amd?define(["exports","video.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).videojsContribEme={},e.videojs)}(this,(function(e,t){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=s(t);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},i.apply(this,arguments)}const r=(e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const s=new DataView(e),n=new DataView(t);for(let e=0;e<s.byteLength;e++)if(s.getUint8(e)!==n.getUint8(e))return!1;return!0},a=e=>e instanceof Uint8Array||e instanceof Uint16Array?e.buffer:e,o=(...e)=>{const t=n.default.obj||n.default;return(t.merge||t.mergeOptions).apply(t,e)},y=(...e)=>{const t=o(...e);return Object.keys(t).forEach((e=>{null===t[e]&&delete t[e]})),t},d=e=>{const t=[];return Object.keys(e).forEach((s=>{const n=E(s,e[s])[0];t.push(n)})),t};let c=n.default.xhr.httpHandler;c||(c=(e,t)=>(s,n,i)=>{if(s)e(s);else{if(n.statusCode>=400&&n.statusCode<=599){let s=i;return t&&(s=String.fromCharCode.apply(null,new Uint8Array(i))),void e({cause:s})}e(null,i)}});const l=(e,t,s,i,r)=>{const a=(e=>{const t=String.fromCharCode.apply(null,new Uint16Array(e)),s=(new window.DOMParser).parseFromString(t,"application/xml"),n=s.getElementsByTagName("HttpHeaders")[0];let i={};if(n){const e=n.getElementsByTagName("name"),t=n.getElementsByTagName("value");for(let s=0;s<e.length;s++)i[e[s].childNodes[0].nodeValue]=t[s].childNodes[0].nodeValue}const r=s.getElementsByTagName("Challenge")[0];let a;return r&&(a=window.atob(r.childNodes[0].nodeValue)),s.querySelector("parsererror")&&(i={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"http://schemas.microsoft.com/DRM/2007/03/protocols/AcquireLicense"'},a=e),{headers:i,message:a}})(s),o=a.message,d=y(a.headers,i.emeHeaders,t.licenseHeaders);n.default.xhr({uri:t.url,method:"post",headers:d,body:o,responseType:"arraybuffer",requestType:"license",metadata:{keySystem:e}},c(r,!0))},m={EMEFailedToRequestMediaKeySystemAccess:"eme-failed-request-media-key-system-access",EMEFailedToCreateMediaKeys:"eme-failed-create-media-keys",EMEFailedToAttachMediaKeysToVideoElement:"eme-failed-attach-media-keys-to-video",EMEFailedToCreateMediaKeySession:"eme-failed-create-media-key-session",EMEFailedToSetServerCertificate:"eme-failed-set-server-certificate",EMEFailedToGenerateLicenseRequest:"eme-failed-generate-license-request",EMEFailedToUpdateSessionWithReceivedLicenseKeys:"eme-failed-update-session",EMEFailedToCloseSession:"eme-failed-close-session",EMEFailedToRemoveKeysFromSession:"eme-failed-remove-keys",EMEFailedToLoadSessionBySessionId:"eme-failed-load-session"},p="com.apple.fps.1_0",u=({initData:e,id:t,cert:s})=>{"string"==typeof t&&(t=(e=>{const t=new ArrayBuffer(2*e.length),s=new Uint16Array(t);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);return s})(t));let n=0;const i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+s.byteLength),r=new DataView(i);new Uint8Array(i,n,e.byteLength).set(e),n+=e.byteLength,r.setUint32(n,t.byteLength,!0),n+=4;const a=new Uint16Array(i,n,t.length);a.set(t),n+=a.byteLength,r.setUint32(n,s.byteLength,!0),n+=4;return new Uint8Array(i,n,s.byteLength).set(s),new Uint8Array(i,0,i.byteLength)},f=(e,t)=>(s,i)=>{const r=y(s.emeHeaders,t.certificateHeaders);n.default.xhr({uri:t.certificateUri,responseType:"arraybuffer",requestType:"license",metadata:{keySystem:e},headers:r},c(((e,t)=>{e?i(e):i(null,new Uint8Array(t))})))},g=(e,t)=>(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(t),k=(e,t)=>(s,i,r,a)=>{const o=y({"Content-type":"application/octet-stream"},s.emeHeaders,t.licenseHeaders);n.default.xhr({uri:t.licenseUri||t.url,method:"POST",responseType:"arraybuffer",requestType:"license",metadata:{keySystem:e,contentId:i},body:r,headers:o},c(a,!0))},h=({video:e,initData:t,options:s,eventBus:n,emeError:i})=>{const r=s.keySystems["com.apple.fps.1_0"],a=r.getCertificate||f(p,r),o=r.getContentId||g,y=r.getLicense||k(p,r);return new Promise(((e,t)=>{a(s,((s,n)=>{if(s){return i(s,{errorType:m.EMEFailedToSetServerCertificate,keySystem:p}),void t(s)}e(n)}))})).then((r=>{return(({video:e,contentId:t,initData:s,cert:n,options:i,getLicense:r,eventBus:a,emeError:o})=>new Promise(((y,d)=>{if(!e.webkitKeys)try{e.webkitSetMediaKeys(new window.WebKitMediaKeys(p))}catch(e){return o(e,{errorType:m.EMEFailedToCreateMediaKeys,keySystem:p}),void d("Could not create MediaKeys")}let c;try{c=e.webkitKeys.createSession("video/mp4",u({id:t,initData:s,cert:n}))}catch(e){return o(e,{errorType:m.EMEFailedToCreateMediaKeySession,keySystem:p}),void d("Could not create key session")}v(a,{type:"keysessioncreated",keySession:c}),c.contentId=t,c.addEventListener("webkitkeymessage",(e=>{v(a,{type:"keymessage",messageEvent:e}),r(i,t,e.message,((e,t)=>{if(a&&v(a,{type:"licenserequestattempted"}),e)return o(e,{errortype:m.EMEFailedToGenerateLicenseRequest,keySystem:p}),void d(e);c.update(new Uint8Array(t)),v(a,{type:"keysessionupdated",keySession:c})}))})),c.addEventListener("webkitkeyadded",(()=>{y()})),c.addEventListener("webkitkeyerror",(()=>{const e=c.error;o(e,{errorType:m.EMEFailedToUpdateSessionWithReceivedLicenseKeys,keySystem:p}),d(`KeySession error: code ${e.code}, systemCode ${e.systemCode}`)}))})))({video:e,cert:r,initData:t,getLicense:y,options:s,contentId:o(s,(a=t,String.fromCharCode.apply(null,new Uint16Array(a.buffer||a)))),eventBus:n,emeError:i});var a}))},S=e=>e.startsWith("com.apple.fps"),v=(e,t)=>{e.isDisposed()||e.trigger(i({},t))},E=(e,t)=>{if(t.supportedConfigurations)return t.supportedConfigurations;const s=S(e),n={},r=t.initDataTypes||(s?["sinf"]:null),a=t.audioContentType,o=t.audioRobustness,y=t.videoContentType||(s?"video/mp4":null),d=t.videoRobustness,c=t.persistentState;return(a||o)&&(n.audioCapabilities=[i({},a?{contentType:a}:{},o?{robustness:o}:{})]),(y||d)&&(n.videoCapabilities=[i({},y?{contentType:y}:{},d?{robustness:d}:{})]),c&&(n.persistentState=c),r&&(n.initDataTypes=r),[n]},w=(e,t)=>{const{mediaKeys:s,initDataType:i,initData:r,options:a,getLicense:o,removeSession:y,eventBus:d,contentId:c,emeError:l,keySystem:p}=t;let u,f=0;e.on("pause",(()=>{a.limitRenewalsMaxPauseDuration&&"number"==typeof a.limitRenewalsMaxPauseDuration&&(u=setInterval((()=>{f++,f>=a.limitRenewalsMaxPauseDuration&&clearInterval(u)}),1e3),e.on("play",(()=>{clearInterval(u),f=0})))}));try{const t=s.createSession(),u=()=>{n.default.log.debug("Session expired, closing the session."),t.close().then((()=>{d.isDisposed()||(v(d,{type:"keysessionclosed",keySession:t}),y(r))})).catch((e=>{l(e,{errorType:m.EMEFailedToCloseSession,keySystem:p})}))};return v(d,{type:"keysessioncreated",keySession:t}),e.on("dispose",(()=>{u()})),new Promise(((s,y)=>{t.addEventListener("message",(n=>{if(v(d,{type:"keymessage",messageEvent:n}),"license-request"===n.messageType||"license-renewal"===n.messageType){if("license-renewal"===n.messageType){const t=a.limitRenewalsBeforePlay,s=a.limitRenewalsMaxPauseDuration,n="number"==typeof s,i=!e.hasStarted()&&t,r=e.paused()&&n&&f>=s,o=e.ended();if(i||r||o)return void u()}o(a,n.message,c).then((e=>{s(t.update(e).then((()=>{v(d,{type:"keysessionupdated",keySession:t})})).catch((e=>{l(e,{errorType:m.EMEFailedToUpdateSessionWithReceivedLicenseKeys,keySystem:p})})))})).catch((e=>{y(e)}))}}),!1);const g="keystatuseschange";t.addEventListener(g,(e=>{let s=!1;d.isDisposed()||(v(d,{type:g,keyStatuses:t.keyStatuses}),t.keyStatuses.forEach(((i,r)=>{switch(v(d,{keyId:r,status:i,target:t,type:"keystatuschange"}),i){case"expired":s=!0;break;case"internal-error":const t='Key status reported as "internal-error." Leaving the session open since we don\'t have enough details to know if this error is fatal.';n.default.log.warn(t,e)}})),s&&u())}),!1),t.generateRequest(i,r).catch((e=>{l(e,{errorType:m.EMEFailedToGenerateLicenseRequest,keySystem:p}),y("Unable to create or initialize key session")}))}))}catch(e){l(e,{errorType:m.EMEFailedToCreateMediaKeySession,keySystem:p})}},b=(e,t)=>{if("string"==typeof t&&(t={url:t}),!t.url&&t.licenseUri&&(t.url=t.licenseUri),!t.url&&!t.getLicense)throw new Error(`Missing url/licenseUri or getLicense in ${e} keySystem configuration.`);const s=S(e);if(s&&t.certificateUri&&!t.getCertificate&&(t.getCertificate=f(e,t)),s&&!t.getCertificate)throw new Error(`Missing getCertificate or certificateUri in ${e} keySystem configuration.`);return s&&!t.getContentId&&(t.getContentId=g),t.url&&!t.getLicense&&(t.getLicense="com.microsoft.playready"===e?((e,t)=>(s,n,i)=>{l(e,t,n,s,i)})(e,t):s?k(e,t):((e,t)=>(s,i,r)=>{const a=y({"Content-type":"application/octet-stream"},s.emeHeaders,t.licenseHeaders);n.default.xhr({uri:t.url,method:"POST",responseType:"arraybuffer",requestType:"license",metadata:{keySystem:e},body:i,headers:a},c(r,!0))})(e,t)),t},T=({player:e,video:t,initDataType:s,initData:n,keySystemAccess:i,options:r,removeSession:a,eventBus:o,emeError:y})=>{let d=Promise.resolve();const c=i.keySystem;let l;try{l=b(c,r.keySystems[c])}catch(e){return Promise.reject(e)}const p=l.getContentId?l.getContentId(r,(u=n,String.fromCharCode.apply(null,new Uint8Array(u.buffer||u)))):null;var u;if(void 0===t.mediaKeysObject){let s;t.mediaKeysObject=null,t.pendingSessionData=[],d=new Promise(((e,n)=>{t.keySystem=c,l.getCertificate?l.getCertificate(r,((t,i)=>{t?n(t):(s=i,e())})):e(i)})).then((()=>i.createMediaKeys())).then((n=>(v(o,{type:"keysystemaccesscomplete",mediaKeys:n}),(({player:e,video:t,certificate:s,createdMediaKeys:n,emeError:i})=>{t.mediaKeysObject=n;const r=[];s&&r.push(n.setServerCertificate(s).catch((e=>{const s={errorType:m.EMEFailedToSetServerCertificate,keySystem:t.keySystem};i(e,s)})));for(let s=0;s<t.pendingSessionData.length;s++){const n=t.pendingSessionData[s];r.push(w(e,{mediaKeys:t.mediaKeysObject,initDataType:n.initDataType,initData:n.initData,options:n.options,getLicense:n.getLicense,removeSession:n.removeSession,eventBus:n.eventBus,contentId:n.contentId,emeError:n.emeError,keySystem:t.keySystem}))}return t.pendingSessionData=[],r.push(t.setMediaKeys(n).catch((e=>{const s={errorType:m.EMEFailedToAttachMediaKeysToVideoElement,keySystem:t.keySystem};i(e,s)}))),Promise.all(r)})({player:e,video:t,certificate:s,createdMediaKeys:n,emeError:y})))).catch((e=>(y(e,{errorType:m.EMEFailedToCreateMediaKeys,keySystem:c}),e?Promise.reject(e):Promise.reject("Failed to create and initialize a MediaKeys object"))))}return d.then((()=>{const i=t.keySystem?((e,t,s)=>(n,i,r)=>new Promise(((a,o)=>{const y=function(e,t){s&&v(s,{type:"licenserequestattempted"}),e?o(e):a(t)};S(e)?t(n,r,new Uint8Array(i),y):t(n,i,y)})))(c,l.getLicense,o):null;return(({player:e,video:t,initDataType:s,initData:n,options:i,getLicense:r,contentId:a,removeSession:o,eventBus:y,emeError:d})=>{const c={initDataType:s,initData:n,options:i,getLicense:r,removeSession:o,eventBus:y,contentId:a,emeError:d,keySystem:t.keySystem};return t.mediaKeysObject?(c.mediaKeys=t.mediaKeysObject,w(e,c)):(t.pendingSessionData.push(c),Promise.resolve())})({player:e,video:t,initDataType:s,initData:n,options:r,getLicense:i,contentId:p,removeSession:a,eventBus:o,emeError:y})}))},M="com.microsoft.playready",C=(e,t,s,n,i)=>{const r=e.msKeys.createSession("video/mp4",t);if(!r){const e=new Error("Could not create key session.");throw i(e,{errorType:m.EMEFailedToCreateMediaKeySession,keySystem:M}),e}v(n,{type:"keysessioncreated",keySession:r}),r.addEventListener("mskeymessage",(e=>{v(n,{type:"keymessage",messageEvent:e}),((e,t,s,n,i)=>{let r=e.keySystems[M];if("function"==typeof r.getKey)return void r.getKey(e,s.destinationURL,s.message.buffer,((s,r)=>{if(s){const r={errorType:m.EMEFailedToRequestMediaKeySystemAccess,config:d(e.keySystems)};return i(s,r),void v(n,{message:"Unable to get key: "+s,target:t,type:"mskeyerror"})}t.update(r),v(n,{type:"keysessionupdated",keySession:t})}));"string"==typeof r?r={url:r}:"boolean"==typeof r&&(r={}),r.url||(r.url=s.destinationURL);const a=(e,s)=>{if(n&&v(n,{type:"licenserequestattempted"}),e)return i(e,{errorType:m.EMEFailedToGenerateLicenseRequest,keySystem:M}),void v(n,{message:"Unable to request key from url: "+r.url,target:t,type:"mskeyerror"});t.update(new Uint8Array(s))};r.getLicense?r.getLicense(e,s.message.buffer,a):l(M,r,s.message.buffer,e,a)})(s,r,e,n,i)})),r.addEventListener("mskeyerror",(e=>{const t={errorType:m.EMEFailedToCreateMediaKeySession,keySystem:M};i(r.error,t),v(n,{message:`Unexpected key error from key session with code: ${r.error.code} and systemCode: ${r.error.systemCode}`,target:r,type:"mskeyerror"})})),r.addEventListener("mskeyadded",(()=>{v(n,{target:r,type:"mskeyadded"})}))};const K=[{initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4;codecs="mp4a.40.2"'}],videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"'}]}],D=[{keySystem:"com.apple.fps",supportedConfig:[{initDataTypes:["sinf"],videoCapabilities:[{contentType:"video/mp4"}]}]},{keySystem:"com.microsoft.playready.recommendation",supportedConfig:K},{keySystem:"com.widevine.alpha",supportedConfig:K},{keySystem:"org.w3.clearkey",supportedConfig:K}],L=()=>{const e=window.Promise,t={fairplay:Boolean(window.WebKitMediaKeys),playready:!1,widevine:!1,clearkey:!1};return window.MediaKeys&&window.navigator.requestMediaKeySystemAccess?e.all(D.map((({keySystem:e,supportedConfig:t})=>window.navigator.requestMediaKeySystemAccess(e,t).catch((()=>{}))))).then((([e,s,n,i])=>(t.fairplay=Boolean(e),t.playready=Boolean(s),t.widevine=Boolean(n),t.clearkey=Boolean(i),t))):e.resolve(t)};const _=(e,t)=>{for(let s=0;s<e.length;s++){if(!e[s].initData)continue;const n=a(e[s].initData),i=a(t);if(r(n,i))return!0}return!1},F=(e,t)=>{for(let s=0;s<e.length;s++)if(e[s].initData===t)return void e.splice(s,1)};function U(e,t,s,i,r,a){if(!s||!s.keySystems)return Promise.resolve();if(s.keySystems["com.apple.fps.1_0"])return n.default.log.debug("eme","Ignoring 'encrypted' event, using legacy fairplay keySystem com.apple.fps.1_0"),Promise.resolve();let o=t.initData;return(e=>{let t;return Object.keys(e).forEach((s=>{const n=E(s,e[s]);t=t?t.catch((e=>window.navigator.requestMediaKeySystemAccess(s,n))):window.navigator.requestMediaKeySystemAccess(s,n)})),t})(s.keySystems).then((n=>{const y=n.keySystem;return s.keySystems[y]&&s.keySystems[y].pssh&&(o=s.keySystems[y].pssh),_(i,o)||!o?Promise.resolve():(i.push({initData:o}),T({player:e,video:t.target,initDataType:t.initDataType,initData:o,keySystemAccess:n,options:s,removeSession:F.bind(null,i),eventBus:r,emeError:a}))})).catch((e=>{const t={errorType:m.EMEFailedToRequestMediaKeySystemAccess,config:d(s.keySystems)};a(e,t)}))}const A=(e,t,s,n)=>t.keySystems&&t.keySystems["com.apple.fps.1_0"]&&e.initData?h({video:e.target,initData:e.initData,options:t,eventBus:s,emeError:n}):Promise.resolve(),P=(e,t,s,n,i)=>{if(!t.keySystems||!t.keySystems[M])return;if(s.reduce(((e,t)=>e||t.playready),!1))return;let r=e.initData;t.keySystems[M]&&t.keySystems[M].pssh&&(r=t.keySystems[M].pssh),r&&(s.push({playready:!0,initData:r}),(({video:e,initData:t,options:s,eventBus:n,emeError:i})=>{e.msKeys&&delete e.msKeys;try{e.msSetMediaKeys(new window.MSMediaKeys(M))}catch(e){throw i(e,{errorType:m.EMEFailedToCreateMediaKeys,keySystem:M}),new Error("Unable to create media keys for PlayReady key system. Error: "+e.message)}C(e,t,s,n,i)})({video:e.target,initData:r,options:t,eventBus:n,emeError:i}))},R=e=>o(e.currentSource(),e.eme.options),B=e=>{const t=e.src();t!==e.eme.activeSrc&&(e.eme.activeSrc=t,e.eme.sessions=[])},q=e=>(t,s)=>{const n={code:5};"string"==typeof t?n.message=t:t&&(t.message&&(n.message=t.message),t.cause&&(t.cause.length||t.cause.byteLength)&&(n.cause=t.cause),t.keySystem&&(n.keySystem=t.keySystem),n.originalError=t),s&&(n.metadata=s),e.error(n)},j=(e,t)=>{if("video"===e.$(".vjs-tech").tagName.toLowerCase())if(B(e),window.MediaKeys){const s=()=>{const s={initDataType:"cenc",initData:null,target:e.tech_.el_};B(e),U(e,s,R(e),e.eme.sessions,e.tech_,t)};if(n.default.browser.IS_FIREFOX){let t;e.on("ended",(()=>{t=!1,e.one(["seek","play"],(n=>{t||0!==e.eme.sessions.length||(s(),t=!0)}))})),e.on("play",(()=>{const n=e.eme.options.limitRenewalsMaxPauseDuration;0===e.eme.sessions.length&&"number"==typeof n&&(t=!0,s())}))}e.tech_.el_.addEventListener("encrypted",(s=>{n.default.log.debug("eme","Received an 'encrypted' event"),B(e),U(e,s,R(e),e.eme.sessions,e.tech_,t)}))}else if(window.WebKitMediaKeys)e.eme.initLegacyFairplay();else if(window.MSMediaKeys){e.tech_.el_.addEventListener("msneedkey",(s=>{n.default.log.debug("eme","Received an 'msneedkey' event"),B(e);try{P(s,R(e),e.eme.sessions,e.tech_,t)}catch(e){t(e)}}));const s=e=>{t(e)};e.tech_.on("mskeyerror",s),e.on("dispose",(()=>{e.tech_.off("mskeyerror",s)}))}},I=function(e={}){const t=this,s=q(t);t.ready((()=>j(t,s))),t.eme={setupEmeListeners(){j(t,s)},initializeMediaKeys(n={},i=function(){},r=!1){const a=o(t.currentSource(),e,n),y={initDataType:"cenc",initData:null,target:t.tech_.el_};if(B(t),window.MediaKeys)U(t,y,a,t.eme.sessions,t.tech_,s).then((()=>i())).catch((e=>{i(e),r||s(e)}));else if(window.MSMediaKeys){const e=n=>{t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),"mskeyerror"===n.type?(i(n.target.error),r||s(n.message)):i()};t.tech_.one("mskeyadded",e),t.tech_.one("mskeyerror",e);try{P(y,a,t.eme.sessions,t.tech_,s)}catch(n){t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),i(n),r||s(n)}}},initLegacyFairplay(){const e=e=>{n.default.log.debug("eme","Received a 'webkitneedkey' event"),B(t),A(e,R(t),t.tech_,s).catch((e=>{s(e)}))},i=s=>{const n=R(t).firstWebkitneedkeyTimeout||1e3,i=t.src();t.eme.webkitneedkey_=t.eme.webkitneedkey_||{},t.eme.webkitneedkey_.src!==i&&(t.eme.webkitneedkey_={handledFirstEvent:!1,src:i}),t.eme.webkitneedkey_.handledFirstEvent?e(s):(t.clearTimeout(t.eme.webkitneedkey_.timeout),t.eme.webkitneedkey_.timeout=t.setTimeout((()=>{t.eme.webkitneedkey_.handledFirstEvent=!0,t.eme.webkitneedkey_.timeout=null,e(s)}),n))};let r=t.tech_.el_;r.addEventListener("webkitneedkey",i);const a=()=>{t.off("dispose",a),null!==r&&r.removeEventListener("webkitneedkey",i),r=null};return t.on("dispose",a),a},detectSupportedCDMs:L,options:e}};n.default.registerPlugin("eme",I),I.Error=m,I.VERSION="5.5.1",e.default=I,e.emeErrorHandler=q,e.getOptions=R,e.handleEncryptedEvent=U,e.handleMsNeedKeyEvent=P,e.handleWebKitNeedKeyEvent=A,e.hasSession=_,e.removeSession=F,e.setupSessions=B,Object.defineProperty(e,"__esModule",{value:!0})}));
